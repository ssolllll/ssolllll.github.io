---
layout: post
title: "[LLM Ops] AI 에이전트의 블랙박스를 여는 기술: H.E.A.R. 감사 로그 전략"
date: 2025-12-21 10:00:00
description: 수백 건의 자율 실행을 수행하는 AI 에이전트. 단순 로그를 넘어 의도(Intent)와 맥락(Context)을 추적하는 감사 시스템 구축 가이드.
tags: llm ai-agent mlops observability security compliance
categories: engineering
---

LLM이 단순한 챗봇(Chatbot)을 넘어 도구를 사용하고 의사결정을 내리는 **에이전트(Agent)** 로 진화하면서, 엔지니어링의 난이도는 '생성'에서 '통제'와 '추적'으로 이동하고 있다.

에이전트가 `계획(Plan) -> 행동(Action) -> 도구 호출(Tool Use) -> 결과 해석(Observation)`의 다단계 과정을 자율적으로 수행할 때, 기존의 "Request-Response" 로그만으로는 사고 발생 시 원인을 파악하기 불가능하다.

"왜 AI가 대출 승인을 거절했는가?", "왜 환불 금액을 2만 원으로 책정했는가?"

이 질문에 답하기 위해 필요한 **인간이 이해할 수 있는 감사 추적(Audit Trail)** 시스템 구축 전략을 정리한다.

---

## 1. 왜 지금 '감사 로그'인가?

단순 API 호출이 아니라 **의사결정의 연쇄(Chain of Decisions)** 가 일어나기 때문이다.

1.  **맥락의 단절:** 사용자의 질문 하나에 에이전트는 내부적으로 수십 번의 API 호출과 추론을 거친다. 결과값만 남기면 중간 과정의 오류(Hallucination)나 잘못된 도구 사용을 찾아낼 수 없다.
2.  **규제 준수 (Compliance):** 금융권의 ISMS-P, ISO 42001(AI 경영시스템) 등은 AI의 투명성과 설명 가능성을 요구한다.
3.  **사고 재현 및 디버깅:** 동일한 입력에도 다른 결과를 낼 수 있는 LLM의 비결정성(Non-determinism)을 통제하려면, 당시의 환경과 파라미터 스냅샷이 필수적이다.

---

## 2. 핵심 원칙: H.E.A.R.

우리는 기술적인 로그와 비즈니스적인 설명을 분리하되 연결해야 한다. 이를 위한 4가지 원칙을 제안한다.

* **Human-Readable (가독성):** JSON 덤프와 별개로, 에이전트가 스스로 자신의 행동을 3~5줄로 요약한 '설명 노트'를 남겨야 한다. 사람이 로그를 해석하는 시간을 획기적으로 줄여준다.
* **Event-Sourced (이벤트 소싱):** 모든 의사결정과 행동을 불변(Immutable)의 이벤트 스트림으로 저장한다. 이는 나중에 시점별 상태를 재구성하는 기반이 된다.
* **Attribution (책임 소재):** 이 결정이 '어떤 프롬프트 버전', '어떤 모델', '어떤 데이터 출처'에서 나왔는지 명확히 분리하여 기록한다.
* **Reproducibility (재현성):** 문제가 된 상황을 똑같이 다시 실행해 볼 수 있도록 환경 변수와 외부 API 응답값까지 스냅샷을 뜬다.

---

## 3. 최소 구현 아키텍처



### A. 행동 단위 (Action Unit)
에이전트의 생각과 행동을 가장 작은 단위로 쪼개어 표준 스키마로 기록한다. `trace_id`를 통해 전체 실행 흐름을 트리(Tree) 구조로 엮는다.

* **Trace Context:** `trace_id`, `parent_id`
* **Thinking:** `intent`(사용자 의도), `plan_step`(현재 계획 단계)
* **Action:** `tool_name`, `args_hash`, `input_redacted`(마스킹된 입력)
* **Result:** `result_digest`(결과 요약 해시), `cost`(토큰 비용), `latency`

### B. 서술 로그 (Narrative Log)
기계적인 로그 외에, 에이전트에게 **"지금 뭘 했고 왜 했는지"**를 자연어로 남기게 한다.
> *"영수증에서 항목을 추출하고(증거 A) 수업료는 교육실비로 분류함. 미술/피아노 등 세부 실기료는 제외 규정에 따라 필터링. 최종 한도 계산 결과 2,500,000원 잔여."*

### C. 저장 및 뷰 계층
* **Storage:** Kafka/Redpanda 같은 Append-only 로그로 수집 후, S3 같은 객체 스토리지에 장기 보관한다. (WORM 옵션 적용 시 위변조 방지 가능)
* **Viewer:** 단순 텍스트 뷰어가 아닌, 타임라인(Gantt Chart)이나 의사결정 트리 형태로 시각화하여 "어디서 병목이 걸렸는지", "어디서 리스크 플래그가 떴는지" 한눈에 파악한다.

---

## 4. 스키마 예시 (JSON)

실제 프로덕션 환경에서 사용 가능한 로그 스키마의 예시다.

```json
{
  "trace_id": "7f8a9d12-...",
  "parent_id": "3b2c1e...",
  "timestamp": "2025-12-21T14:30:00Z",
  "actor": {
    "type": "agent",
    "name": "tuition-bot",
    "model": "gpt-5-mini:2025-10" // 모델 버전 명시
  },
  "intent": "학자금 영수증 항목 분류 및 한도 체크",
  "plan_step": "extract -> classify -> limit-calc",
  
  "tool_call": {
    "name": "ocr.extract",
    "args_redacted": "{'file_id': '***', 'user_id': 'user_123'}", // 민감정보 마스킹
    "result_digest": "sha256:e3b0c44298fc...",
    "latency_ms": 412,
    "cost": {
      "tokens_in": 1234, 
      "tokens_out": 256
    }
  },
  
  "policy_flags": ["PII_DETECTED", "FIN_DATA"], // 리스크 플래그
  "evidence": [
    {"type": "sample", "path": "s3://logs/evidence/resp.snip.json"}
  ],
  
  "narrative": "영수증 OCR 추출 완료. 수업료 항목을 식별하여 교육실비로 분류함. 미술 실기료는 규정에 의거하여 지급 대상에서 제외 처리."
}